# SDDup Experiment
This is a simple experiment to measure gains in storage efficiency when applying the SDDup protocol to files that contains the same structure.

The SDDup protocol has the following approach to optimize storage while keeping data private when dealing with a large amount of files following the same structure: instead of encrypting the entire document for each file, you can instead separate the `unique data` that's unique for each file from the `template` that repeats on every document, and encrypt only the `unique data` while storing only one `template` file. This experiment applies this concept to two distinct types of files: Brazilian's Birth Certificates as PDF files and Brazilian's University Diplomas as XML files.

## About the experiment
This experiment applies the SDDup protocol in a large amount of files containing fake data generated by the [Faker](https://github.com/joke2k/faker) library. PDF files were manipulated using [fillpdf](https://github.com/t-houssian/fillpdf) and files were signed using [pyHanko](https://github.com/MatthiasValvekens/pyHanko). XML files were manipulated using [lxml](https://github.com/lxml/lxml). All data was encrypted using [criptography](https://github.com/pyca/cryptography).

The experiment has 3 distinct steps: `file generation`, `data extraction and encryption` and `data decryption and file recreation`.

### File generation
This step is responsible for generating a large amount of PDF and XML files to apply the SDDup protocol. It's fairly straightforward: fake data is generated with the help of the Faker library, and then the PDF or XML file is created by filling the respective template file with the generated data. Additionally, PDF files are signed using the pyHanko library.

Generated PDF files are stored at `sddup/outputs/pdf/generated_pdfs`, while XML files are stored at `sddup/outputs/xml/generated_xmls`.
 
### Data extraction and encryption
This step extracts the unique data from the previously created PDF and XML files, and then encrypts it with `AES-256-CBC` before storing it to a file as raw bytes. Data is stored as a single string containing all values separated by a special symbol, depending on the structure specified for each file type.

Extracted PDF data is stored at `sddup/outputs/pdf/extracted_data`, while XML data is stored at `sddup/outputs/xml/extracted_data`

#### PDF data extraction structure
PDF extracted data contains the value of the PDF's form fields and the raw bytes of the signature structure inside the PDF. The form values are stored by alphabetical order of the field's names, followed by the signature structure's bytes.

For example, if there were only 3 form fields called `Full name`, `Date of birth` and `City of birth`, the data string would have the following structure: `city-of-birth-value`#`date-of-birth-value`#`full-name-value`#`signature-structure-bytes`

#### XML data extraction structure
XML extracted data contains either the relative path of a tag from a specific point of the tree and the tag's value (generally for user data),  or the number of occurrence of that tag is saved alongside their value and attributes (for signatures and timestamps). 

For example, let's assume the user data is archived in the following path: `/diploma/infDiploma/infGraduate`. Since this repeats for all data inside this part of the tree, it's only necessary to store the relative path after it and the tag's value: `/ID:id-value`, `/Name/FirstName:firstname-value`, `/Name/LastName:lastname-value`. 

To exemplify for signatures and timestamps, their tags contains the attribute `id`, so we can archive data in the following way: `signature-tag-name:occurence-number:id-value:tag-value`.

### Data decryption and file recreation
This step decrypts the data extracted on the previous step and recreates the original file by filling their respective templates with the extracted values. Since the extracted data follows a specific structure, file recreation is trivial. Hash values of the original file and the recreated file are compared to ensure the files are digitally the same.

Additionaly, efficiency values are calculated comparing the amount of bytes used when storing all files on their entirety and when applying the SDDup protocol.

Recreated PDF files are stored at `sddup/outputs/pdf/recreated_pdfs`, while XML files are stored at `sddup/outputs/xml/recreated_xmls`


## How to run the experiment
The experiment has been developed using Python 3.12.10 and [Poetry](https://python-poetry.org/). First of all, download Poetry on your Linux machine through the official website of with the following command:

```
curl -sSL https://install.python-poetry.org | python3 -
```

After installing Poetry, run the following command at the root of the project:

```
poetry install
```

Finally, the project can be executed with the following command at the root of the project:

```
poetry run python3 sddup [experiment_type] [amount]
```
Both arguments are optional and have the following meaning:

* experiment_type - Type of experiment to be run, either `pdf`, `xml` or `both`. Default `both`.
* amount - Amount of files to be generated and processed, must be a positive integer. Default `100`.

## Test output
Tests are considered successful when the hash from the generated documents matches with its reconstructed counterpart. Since the hashes of the documents are the same, we can infer that document integrity and signatures are maintained.
